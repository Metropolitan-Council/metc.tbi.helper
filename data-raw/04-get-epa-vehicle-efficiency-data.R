# FIXME: This script needs work

# # This script is writen to run after
# # 03-get-geographic-boundaries.R
#
# # Read from online -----------
# message("Downloading fuel economy data from EPA website")
# # https://www.fueleconomy.gov/feg/download.shtml
# epa_raw <-
#   read.csv("https://www.fueleconomy.gov/feg/epadata/vehicles.csv") %>%
#   as.data.table()
# # see README for documentation/metadata
#
# # Trim Columns ----------------
# message("Rearranging EPA data")
#
# epa_raw[co2 == -1, co2 := NA]
# epa_raw[co2A == -1, co2A := NA]
# across()
# epa_raw[co2TailpipeAGpm == 0, co2TailpipeAGpm := NA]
# epa_raw[co2TailpipeGpm == 0, co2TailpipeGpm := NA]
# epa_raw[city08U == 0, city08U := NA]
# epa_raw[cityA08U == 0, cityA08U := NA]
# epa_raw[highway08U == 0, highway08U := NA]
# epa_raw[highwayA08U == 0, highwayA08U := NA]
# epa_raw[highwayA08 == 0, highwayA08 := NA]
#
# epa_sel <-
#   epa_raw[
#     , lapply(.SD, \(x) x %>% mean(na.rm = T, trim = 0.05) %>% round(1))
#     , .SDcols = c("co2", "co2A", 'co2TailpipeAGpm', 'co2TailpipeGpm',
#                   'city08U', 'cityA08U', 'cityA08', 'highway08U',
#                   'highway08', 'highwayA08U', 'highwayA08')
#     , keyby = .(make, model, year, fuelType)
#   ]
#
# # epa_sel <- epa_raw %>%
#   # select(
#   #   make,
#   #   model,
#   #   year,
#   #   fuelType,
#   #   # "Electricity" for electric cars
#   #   co2,
#   #   co2A,
#   #   co2TailpipeAGpm,
#   #   co2TailpipeGpm,
#   #   city08U,
#   #   # city MPG for fuelType1 (2), (11)
#   #   city08,
#   #   # unrounded city MPG for fuelType1 (2), (3)
#   #   cityA08U,
#   #   # city MPG for fuelType2 (2)
#   #   cityA08,
#   #   # unrounded city MPG for fuelType2 (2), (3)
#   #   # same for highways:
#   #   highway08U,
#   #   highway08,
#   #   highwayA08U,
#   #   highwayA08
#   # )
# #
# # # Fix up model/makes to ease matching to vehicle dataset ------------------
# # epa_fix <- epa_sel %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "BMW" & grepl(pattern = "^[[:digit:]]", model) ~
# #           paste(substr(model, start = 1, stop = 1), "Series"),
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "BMW" & grepl(pattern = "^[A-Z|a-z]", model) ~
# #           paste(substr(model, start = 1, stop = 2)),
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Mazda" & grepl(pattern = "^[[:digit:]] ", model) ~
# #           paste0("Mazda", substr(model, start = 1, stop = 1)),
# #         # WHY DOES THIS KEEP PUTTING A SPACE BETWEEN MAZDA and THE NUMBER?!?!
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Mazda" & grepl(pattern = "^[[:digit:]]+$", model) ~
# #           paste0("Mazda", substr(model, start = 1, stop = 1)),
# #         # WHY DOES THIS KEEP PUTTING A SPACE BETWEEN MAZDA and THE NUMBER?!?!
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Dodge" &
# #           (
# #             grepl(pattern = "Ram", model) &
# #               grepl(pattern = "Pickup", model)
# #           ) ~
# #           "Ram Pickup",
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Saturn" & grepl(pattern = "Vue", model) ~
# #           "VUE",
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Saturn" & grepl(pattern = "SKY", model) ~
# #           "Sky",
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Saturn" & grepl(pattern = "^L", model) ~
# #           "L Series",
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Saturn" & grepl(pattern = "^S", model) & (!model == "Sky") ~
# #           "S Series",
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(
# #     model =
# #       case_when(
# #         make == "Nissan" & grepl(pattern = "Leaf", model) ~
# #           toupper(model),
# #         TRUE ~ model
# #       )
# #   ) %>%
# #   mutate(model = str_replace(model, pattern = "Lacrosse/Allure", "LaCrosse")) %>%
# #   mutate(model = str_replace(model, pattern = "Town and Country", "Town & Country")) %>%
# #   mutate(model = case_when(grepl(pattern = "F150", model) & make == "Ford" ~ "F-150", TRUE ~ model)) %>%
# #   mutate(model = case_when(grepl(pattern = "F250", model) & make == "Ford" ~ "F-250", TRUE ~ model)) %>%
# #   mutate(model = case_when(grepl(pattern = "F350", model) & make == "Ford" ~ "F-350", TRUE ~ model)) %>%
# #   mutate(model = case_when(grepl(pattern = "F450", model) & make == "Ford" ~ "F-450", TRUE ~ model)) %>%
# #   mutate(make = case_when(grepl(pattern = "Liberty", model) & make == "Jeep" ~ "Chrysler", TRUE ~ make)) %>%
# #   mutate(model = case_when(model == "Ram" & make == "Ram Pickup" & year == 2012 ~ "1500", TRUE ~ model))
# #
# # # Set numeric columns as such, re-code character NULLS to NA:
# # my_num_columns <- c(
# #   "co2",
# #   "co2A",
# #   "co2TailpipeAGpm",
# #   "co2TailpipeGpm",
# #   "city08U",
# #   "city08",
# #   "cityA08U",
# #   "cityA08",
# #   "highway08U",
# #   "highway08",
# #   "highwayA08U",
# #   "highwayA08"
# # )
# #
# # epa_fix2 <-
# #   epa_fix %>%
# #   # make -1 and NULL into proper NAs
# #   mutate(across(
# #     !!(my_num_columns),
# #     ~ na_if(., -1)
# #   )) %>%
# #   # make -1 and NULL into proper NAs
# #   # mutate(across(
# #   #   !!(my_num_columns),
# #   #   ~ na_if(., NULL)
# #   # )) %>%
# #   # make the column numeric
# #   mutate(across(
# #     !!(my_num_columns),
# #     ~ as.numeric(.)
# #   )) %>%
# #   # make zeros NA
# #   mutate(across(
# #     !!(my_num_columns),
# #     ~ na_if(., 0)
# #   ))
# #
# # # Average by make, model, year - multiple styles/engine types for the same car: -------------
# # epa_avg <- epa_fix2 %>%
# #   group_by(make, model, year) %>%
# #   summarise(
# #     across(
# #       !!(my_num_columns),
# #       ~ median(., na.rm = T)
# #     ),
# #     fuelType = first(fuelType)
# #   ) %>% # take the median emissions value for the Make/Model/year
# #   ungroup()
# #
# # epa_coalesce <- epa_avg %>%
# #   mutate(
# #     co2_gpm = coalesce(co2, co2TailpipeGpm, co2A, co2TailpipeAGpm),
# #     mpg_city = coalesce(city08U, city08, cityA08U, cityA08),
# #     mpg_highway = coalesce(highway08U, highway08, highwayA08U, highwayA08),
# #     fuel_type = fuelType
# #   ) %>%
# #   select(make, model, year, co2_gpm, mpg_city, mpg_highway, fuel_type)
# #
# # # Fix up for electric vehicles
# # epa <- epa_coalesce %>%
# #   mutate(co2_gpm = ifelse(fuel_type == "Electricity", 0, co2_gpm)) %>%
# #   mutate(mpg_city = ifelse(fuel_type == "Electricity", Inf, mpg_city)) %>%
# #   mutate(mpg_highway = ifelse(fuel_type == "Electricity", Inf, mpg_highway)) %>%
# #   # Rename fuel type: EPA fuel type
# #   rename(epa_fuel_type = fuel_type)
# #
# # # Matching to Vehicle table ------------
# # message("Matching EPA data to TBI vehicle table")
# #
# # get_veh_epa <- function(veh) {
# #   veh_epa <-
# #     veh %>%
# #     mutate(
# #       model =
# #         case_when(
# #           make == "BMW" & grepl(pattern = "^[[:digit:]] series", model) ~
# #             str_to_title(model),
# #           TRUE ~ model
# #         )
# #     ) %>%
# #     mutate(year = as.character(year)) %>%
# #     mutate(year = case_when(year == "1980" ~ "1980 or earlier", TRUE ~ year)) %>%
# #     # Lightweight dataset of unique vehicles in the TBI -------
# #     select(make, model, year) %>%
# #     unique() %>%
# #     # join by make and year -- ignore model, match across all of them
# #     left_join(
# #       epa %>% mutate(year = as.character(year)),
# #       by = c("make", "year"),
# #       suffix = c(".tbi", ".epa")
# #     ) %>%
# #     # now find where model (from TBI) is *in* the modelf name from EPA using grepl
# #     rowwise() %>%
# #     mutate(
# #       exact_match = ifelse(model.tbi == model.epa, TRUE, FALSE),
# #       pattern_match = grepl(model.tbi, model.epa) # will be true if the characters in model.x are in model.y
# #     ) %>%
# #     # get just the matches:
# #     filter(pattern_match == TRUE | exact_match == TRUE) %>%
# #     mutate(
# #       patternMatchMedianCo2 = median(co2_gpm, na.rm = T),
# #       patternMatchMedianCity = median(mpg_city, na.rm = T),
# #       patternMatchMedianHighway = median(mpg_highway, na.rm = T),
# #       patternMatchModelList = paste0(model.epa, collapse = ","),
# #       n_matches = length(model.epa)
# #     ) %>%
# #     ungroup()
# #
# #
# #   # choose the BEST match for the vehicle/EPA tables:
# #   veh_epa_best <-
# #     veh_epa %>%
# #     group_by(make, model.tbi, year) %>%
# #     # find the best match (will sort from true to false on exact, then true to false on pattern)
# #     arrange(desc(exact_match), desc(pattern_match)) %>%
# #     slice_head(n = 1) %>%
# #     # if there is an exact match, prioritize that first
# #     mutate(
# #       co2_gpm = case_when(
# #         exact_match == TRUE ~ co2_gpm,
# #         # otherwise, go ahead and use the median co2 value from all the pattern matches
# #         pattern_match == TRUE ~ patternMatchMedianCo2
# #       ),
# #       mpg_city = case_when(
# #         exact_match == TRUE ~ mpg_city,
# #         # otherwise, go ahead and use the median co2 value from all the pattern matches
# #         pattern_match == TRUE ~ patternMatchMedianCity
# #       ),
# #       mpg_highway = case_when(
# #         exact_match == TRUE ~ mpg_highway,
# #         # otherwise, go ahead and use the median co2 value from all the pattern matches
# #         pattern_match == TRUE ~ patternMatchMedianHighway
# #       )
# #     ) %>%
# #     mutate(
# #       epa_tbi_veh_match_notes = case_when(
# #         exact_match == TRUE ~ "Exact match",
# #         # otherwise, go ahead and use the median co2 value from all the pattern matches
# #         pattern_match == TRUE &
# #           n_matches == 1 ~ paste0("Used value for: ", patternMatchModelList),
# #         pattern_match == TRUE &
# #           n_matches > 1 ~ paste0(
# #           "Used median value of these ",
# #           n_matches,
# #           " models: ",
# #           patternMatchModelList
# #         )
# #       )
# #     ) %>%
# #     # get rid of anything where there is no match at all (pattern or exact)
# #     filter(!is.na(co2_gpm)) %>%
# #     select(
# #       make,
# #       model.tbi,
# #       year,
# #       co2_gpm,
# #       mpg_city,
# #       mpg_highway,
# #       epa_tbi_veh_match_notes,
# #       epa_fuel_type
# #     )
# #
# #   message("Matching EPA data to TBI vehicle table")
# #   final_dat <-
# #     veh %>%
# #     mutate(
# #       model =
# #         case_when(
# #           make == "BMW" & grepl(pattern = "^[[:digit:]] series", model) ~
# #             str_to_title(model),
# #           TRUE ~ model
# #         )
# #     ) %>%
# #     mutate(year = as.character(year)) %>%
# #     mutate(year = case_when(year == "1980" ~ "1980 or earlier", TRUE ~ year)) %>%
# #     left_join(
# #       veh_epa_best %>%
# #         rename(model = model.tbi),
# #       by = c("year", "make", "model")
# #     )
# #
# #   return(final_dat)
# # }
# #
# # vehicle19 <- get_veh_epa(vehicle19)
# vehicle21 <- get_veh_epa(vehicle21)
# rm(epa_raw, epa_sel, epa_fix, my_num_columns, epa_fix2, epa_avg, epa_coalesce, epa, get_veh_epa)
